#!/bin/bash
set -euo pipefail

function run_commands {
	COMMANDS=$1
	while IFS= read -r cmd; do echo $cmd && eval $cmd ; done < <(printf '%s\n' "$COMMANDS")
}

function run_exit_commands {
	set +e
	set +o pipefail
	run_commands "${POST_COMMANDS_EXIT:-}"
}

main() {
  set +e
  run_commands "${PRE_COMMANDS:-}"
  set -e
  if [ $? -ne 0 ]; then
    run_commands "${POST_COMMANDS_FAILURE:-}"
    exit
  fi

  start=$(date +%s)
  echo Starting prune at "$(date +"%Y-%m-%d %H:%M:%S")"

  set +e
  if ! restic prune ${RESTIC_PRUNE_ARGS:-} "${RESTIC_REPOSITORY}"; then
    set -e
    run_commands "${POST_COMMANDS_FAILURE:-}"
    exit
  else
    set -e
  fi

  echo Prune successful

  end="$(date +%s)"
  echo Finished prune at "$(date +"%Y-%m-%d %H:%M:%S")" after $((end-start)) seconds

  run_commands "${POST_COMMANDS_SUCCESS:-}"
}

trap run_exit_commands EXIT
main "$@"
